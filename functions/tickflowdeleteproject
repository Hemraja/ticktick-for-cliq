
// FUNCTION: tickflowdeleteproject
// Type: Widget Button Function
baseUrl = "https://api.ticktick.com/open/v1";
// 1Ô∏è‚É£ Get projectId from the button
projectId = "";
if(target != null && target.containKey("id"))
{
	projectId = target.get("id");
}
if(projectId == null || projectId == "")
{
	return {"text":"‚ö†Ô∏è No project id provided to delete."};
}
// 2Ô∏è‚É£ Get current user id (same way you use in widget)
uidStr = user.get("id");
// this works in your widget criteria
//------------------------------------------------------
// 3Ô∏è‚É£ Try to get project name from tickflowprojects first
//------------------------------------------------------
projName = "";
projQuery = Map();
projQuery.put("criteria","userid == " + uidStr);
projDb = zoho.cliq.getRecords("tickflowprojects",projQuery);
info "tickflowdeleteproject ‚Üí tickflowprojects (by userid only):";
info projDb;
if(projDb != null && projDb.get("status") == "SUCCESS" && projDb.get("list") != null)
{
	for each  rec in projDb.get("list")
	{
		if(rec.containKey("projectid") && rec.get("projectid") == projectId)
		{
			if(rec.containKey("projectname"))
			{
				projName = rec.get("projectname");
			}
		}
	}
}
//------------------------------------------------------
// 4Ô∏è‚É£ Delete project from TickTick
//------------------------------------------------------
try 
{
	deleteResp = invokeurl
	[
		url :baseUrl + "/project/" + projectId
		type :DELETE
		connection:"ticktick_oauth"
	];
	info "tickflowdeleteproject ‚Üí TickTick deleteResp:";
	info deleteResp;
}
catch (e)
{
	info "tickflowdeleteproject ‚Üí Error deleting project from TickTick:";
	info e;
	// continue to clean DB anyway
}
//------------------------------------------------------
// 5Ô∏è‚É£ Delete matching records from tickflowprojects DB
//------------------------------------------------------
if(projDb != null && projDb.get("status") == "SUCCESS" && projDb.get("list") != null)
{
	for each  rec in projDb.get("list")
	{
		if(rec.containKey("projectid") && rec.get("projectid") == projectId)
		{
			recId = rec.get("id");
			delResp = zoho.cliq.deleteRecord("tickflowprojects",recId);
			info "tickflowdeleteproject ‚Üí deleted tickflowprojects recId: " + recId;
			info delResp;
		}
	}
}
else
{
	info "tickflowdeleteproject ‚Üí No rows fetched from tickflowprojects.";
}
//------------------------------------------------------
// 6Ô∏è‚É£ Delete tasks for that project from tickflowdb
//------------------------------------------------------
taskQuery = Map();
taskQuery.put("criteria","userid == " + uidStr);
taskDb = zoho.cliq.getRecords("tickflowdb",taskQuery);
info "tickflowdeleteproject ‚Üí tickflowdb (by userid only):";
info taskDb;
if(taskDb != null && taskDb.get("status") == "SUCCESS" && taskDb.get("list") != null)
{
	for each  tRec in taskDb.get("list")
	{
		if(tRec.containKey("projectid") && tRec.get("projectid") == projectId)
		{
			tRecId = tRec.get("id");
			tDelResp = zoho.cliq.deleteRecord("tickflowdb",tRecId);
			info "tickflowdeleteproject ‚Üí deleted tickflowdb recId: " + tRecId;
			info tDelResp;
		}
	}
}
else
{
	info "tickflowdeleteproject ‚Üí No rows fetched from tickflowdb.";
}
//------------------------------------------------------
// 7Ô∏è‚É£ Reply
//------------------------------------------------------
msg = "üóëÔ∏è Project deleted.";
if(projName != null && projName != "")
{
	msg = "üóëÔ∏è Project deleted: *" + projName + "*";
}
return {"text":msg};

